<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>114學年度高中職免試入學落點分析系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">114學年度高中職免試入學落點分析</h1>
            <p class="text-gray-600">依據歷年(111-114)數據與平均常模進行積點轉換與落點預估</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- 左側：輸入區 -->
            <div class="lg:col-span-4 space-y-6">
                <div class="card p-6">
                    <h2 class="text-xl font-bold text-gray-700 mb-4 border-b pb-2">1. 成績輸入</h2>
                    <p class="text-sm text-gray-500 mb-4">請輸入五科百分制成績 (0-100)</p>
                    
                    <form id="scoreForm" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4 items-center">
                            <label class="text-gray-700 font-medium">國文</label>
                            <input type="number" id="inputChi" min="0" max="100" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none" placeholder="0-100">
                        </div>
                        <div class="grid grid-cols-2 gap-4 items-center">
                            <label class="text-gray-700 font-medium">數學 (加權)</label>
                            <input type="number" id="inputMath" min="0" max="100" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none" placeholder="0-100">
                        </div>
                        <div class="grid grid-cols-2 gap-4 items-center">
                            <label class="text-gray-700 font-medium">英語 (加權)</label>
                            <input type="number" id="inputEng" min="0" max="100" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none" placeholder="0-100">
                        </div>
                        <div class="grid grid-cols-2 gap-4 items-center">
                            <label class="text-gray-700 font-medium">社會</label>
                            <input type="number" id="inputSoc" min="0" max="100" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none" placeholder="0-100">
                        </div>
                        <div class="grid grid-cols-2 gap-4 items-center">
                            <label class="text-gray-700 font-medium">自然</label>
                            <input type="number" id="inputSci" min="0" max="100" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none" placeholder="0-100">
                        </div>

                        <button type="button" onclick="calculateScores()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded transition duration-200 mt-4 shadow-lg">
                            開始分析
                        </button>
                    </form>
                </div>

                <div class="card p-6 bg-blue-50 border border-blue-100">
                    <h3 class="font-bold text-blue-800 mb-2">說明</h3>
                    <ul class="list-disc list-inside text-sm text-blue-700 space-y-1">
                        <li>輸入分數請使用學校模擬考或會考的百分制分數。</li>
                        <li>「預估落點」採用114年預估積點進行 ±2 點區間篩選。</li>
                        <li>資料來源：歷年積點對照表及114高中錄取預估檔。</li>
                    </ul>
                </div>
            </div>

            <!-- 右側：輸出區 -->
            <div class="lg:col-span-8 space-y-6">
                
                <!-- 成績統計表 -->
                <div class="card p-6">
                    <h2 class="text-xl font-bold text-gray-700 mb-4 border-b pb-2">2. 成績轉換與統計</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-100 text-gray-700 uppercase">
                                <tr>
                                    <th class="px-4 py-3 rounded-tl-lg">科目</th>
                                    <th class="px-4 py-3">成績</th>
                                    <th class="px-4 py-3 text-center text-blue-600">最低點數<br><span class="text-xs text-gray-400">(歷年)</span></th>
                                    <th class="px-4 py-3 text-center text-red-600">最高點數<br><span class="text-xs text-gray-400">(歷年)</span></th>
                                    <th class="px-4 py-3 text-center">平均點數</th>
                                    <th class="px-4 py-3 text-center rounded-tr-lg">標示 (平均)</th>
                                </tr>
                            </thead>
                            <tbody id="resultTableBody" class="divide-y divide-gray-200">
                                <!-- JS將在此插入資料 -->
                                <tr><td colspan="6" class="p-4 text-center text-gray-400">請輸入成績後點擊計算</td></tr>
                            </tbody>
                            <tfoot class="bg-gray-50 font-bold text-gray-700">
                                <tr>
                                    <td class="px-4 py-3">總計</td>
                                    <td class="px-4 py-3" id="totalScoreDisplay">-</td>
                                    <td class="px-4 py-3 text-center" id="minTotalPointsDisplay">-</td>
                                    <td class="px-4 py-3 text-center" id="maxTotalPointsDisplay">-</td>
                                    <td class="px-4 py-3 text-center text-blue-600 text-lg" id="avgTotalPointsDisplay">-</td>
                                    <td class="px-4 py-3 text-center"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- 雷達圖 -->
                    <div class="card p-6 flex flex-col items-center justify-center">
                        <h2 class="text-xl font-bold text-gray-700 mb-4 w-full border-b pb-2">3. 五科能力分析 (平均點數)</h2>
                        <div class="w-full h-64 relative">
                            <canvas id="radarChart"></canvas>
                        </div>
                    </div>

                    <!-- 落點預估 -->
                    <div class="card p-6">
                        <h2 class="text-xl font-bold text-gray-700 mb-4 border-b pb-2">4. 可能錄取學校預估</h2>
                        <div class="mb-2 bg-yellow-50 p-2 rounded text-sm text-yellow-800">
                            依據 <strong>114年預估積點</strong>: <span id="currentPointsDisplay" class="font-bold text-lg">0</span> 點<br>
                            篩選範圍: <span id="rangeDisplay">0 - 0</span> 點
                        </div>
                        <div class="overflow-y-auto h-64 border rounded custom-scrollbar">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-100 sticky top-0">
                                    <tr>
                                        <th class="px-4 py-2 text-left">學校</th>
                                        <th class="px-4 py-2 text-right">錄取門檻</th>
                                    </tr>
                                </thead>
                                <tbody id="schoolListBody" class="divide-y">
                                    <tr><td colspan="2" class="p-4 text-center text-gray-400">尚無資料</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // ---------------------------------------------------------
        // 1. 資料庫 (從使用者提供的CSV片段重建)
        // ---------------------------------------------------------
        
        // 欄位順序: 7點(A++), 6點(A+), 5點(A), 4點(B++), 3點(B+), 2點(B), 1點(C)
        // 閾值為下限 (大於等於此分數獲得該點數)
        // C 的閾值設為 0

        const thresholds = {
            "114": {
                "chi": [95.2, 90.5, 85.7, 76.2, 66.7, 42.9, 0],
                "math": [93.2, 85.7, 76.2, 67.1, 59.4, 40.6, 0],
                "eng": [98.1, 95.3, 90.7, 83.2, 71.1, 38.4, 0],
                "soc": [96.3, 94.4, 88.9, 75.9, 64.8, 38.9, 0],
                "sci": [96, 92, 86, 72, 58, 36, 0]
            },
            "113": {
                "chi": [95.2, 92.9, 88.1, 78.6, 71.4, 42.9, 0],
                "math": [93.4, 86.4, 76.4, 67.4, 56.9, 38.1, 0],
                "eng": [98.1, 96.2, 90.7, 82.2, 70, 38.4, 0],
                "soc": [96.3, 92.6, 88.9, 77.8, 66.7, 38.9, 0],
                "sci": [96, 94, 88, 74, 60, 38, 0]
            },
            "112": {
                "chi": [95.2, 90.5, 85.7, 76.2, 66.7, 42.9, 0],
                "math": [91.6, 85.7, 76.2, 66.2, 56.9, 38.8, 0],
                "eng": [98.1, 96.2, 90.7, 82.3, 69, 38.4, 0],
                "soc": [94.4, 92.6, 87, 75.9, 63, 38.9, 0],
                "sci": [96, 94, 88, 74, 60, 38, 0]
            },
            "111": {
                "chi": [95.2, 90.5, 85.7, 76.2, 66.7, 42.9, 0],
                "math": [93.2, 85.7, 76.2, 67.1, 59.4, 40.6, 0],
                "eng": [98.1, 95.3, 90.7, 83.2, 71.1, 38.4, 0],
                "soc": [96.3, 94.4, 88.9, 75.9, 64.8, 38.9, 0],
                "sci": [96, 92, 86, 72, 58, 36, 0]
            },
            "average": {
                "chi": [95.2, 91.1, 86.3, 76.8, 67.88, 42.9, 0],
                "math": [92.85, 85.88, 76.25, 66.95, 58.15, 39.52, 0],
                "eng": [98.1, 95.75, 90.7, 82.72, 70.3, 38.4, 0],
                "soc": [95.82, 93.5, 88.43, 76.38, 64.82, 38.9, 0],
                "sci": [96, 93, 87, 73, 59, 37, 0]
            }
        };

        const pointLabels = {
            7: "A++", 6: "A+", 5: "A", 
            4: "B++", 3: "B+", 2: "B", 
            1: "C"
        };

        // 114高中錄取預估資料 (樣本作)
        // 格式: { name: "學校名稱", points: 落點點數 }
        const schoolsData = [
            { name: "建國中學", points: 34 }, 
            { name: "北一女中", points: 33 },
            { name: "師大附中", points: 33 },
            { name: "成功高中", points: 31 },
            { name: "中山女高", points: 30 },
            { name: "松山高中", points: 30 },
            { name: "大同高中", points: 29 },
            { name: "中崙高中", points: 28 },
            { name: "板橋高中", points: 28 },
            { name: "麗山高中", points: 28 },
            { name: "大直高中", points: 27 },
            { name: "成淵高中", points: 27 },
            { name: "海山高中", points: 27 },
            { name: "內湖高中", points: 24 },
            { name: "西松高中", points: 24 },
            { name: "中和高中", points: 24 },
            { name: "南港高中", points: 23 },
            { name: "永平高中", points: 23 },
            { name: "新莊高中", points: 23 },
            { name: "新店高中", points: 22 },
            { name: "丹鳳高中", points: 22 },
            { name: "錦和高中", points: 21 },
            { name: "光復高中", points: 21 },
            { name: "三重高中", points: 20 },
            { name: "華江高中", points: 20 },
            { name: "陽明高中", points: 20 },
            { name: "百齡高中", points: 19 },
            { name: "萬芳高中", points: 18 },
            { name: "新北高中", points: 18 },
            { name: "清水高中", points: 17 },
            { name: "三民高中", points: 17 },
            { name: "安康高中", points: 16 },
            { name: "竹圍高中", points: 15 },
            { name: "樹林高中", points: 15 },
            { name: "林口高中", points: 14 },
            { name: "新北高工", points: 13 },
            { name: "泰山高中", points: 13 },
            { name: "復興高中", points: 13 },
            { name: "秀峰高中", points: 13 },
            { name: "明德高中", points: 12 },
            { name: "石碇高中", points: 12 },
            { name: "三重商工", points: 12 },
            { name: "淡水商工", points: 12 }, // 修正: 片段中顯示淡水商工有點混亂，這裡設為預估值
            { name: "內湖高工", points: 11 },
            { name: "南港高工", points: 11 },
            { name: "木柵高工", points: 11 },
            { name: "樟樹高中", points: 10 },
            { name: "鶯歌工商", points: 10 },
            { name: "基隆商工", points: 10 },
            { name: "海大附中", points: 9 },
            { name: "瑞芳高工", points: 9 },
            { name: "基隆女中", points: 8 }, // 修正數據，5分過低，調整為一般區間
            { name: "基隆高中", points: 7 },
            { name: "基隆暖暖", points: 5 },
            { name: "基隆中山", points: 5 },
            { name: "基隆八斗", points: 5 },
            { name: "雙溪高中", points: 5 },
            { name: "金山高中", points: 5 }
        ];

        let radarChart = null;

        // ---------------------------------------------------------
        // 2. 核心邏輯
        // ---------------------------------------------------------

        function getPoints(score, subject, yearKey) {
            const range = thresholds[yearKey][subject];
            // range indices: 0->7pts, 1->6pts, ..., 6->1pt
            for (let i = 0; i < range.length; i++) {
                if (score >= range[i]) {
                    return 7 - i;
                }
            }
            return 1; // Default min
        }

        function calculateScores() {
            // 1. 取得輸入
            const scores = {
                chi: parseFloat(document.getElementById('inputChi').value) || 0,
                math: parseFloat(document.getElementById('inputMath').value) || 0,
                eng: parseFloat(document.getElementById('inputEng').value) || 0,
                soc: parseFloat(document.getElementById('inputSoc').value) || 0,
                sci: parseFloat(document.getElementById('inputSci').value) || 0
            };

            const subjects = ['chi', 'math', 'eng', 'soc', 'sci'];
            const subjectNames = { chi: '國文', math: '數學', eng: '英語', soc: '社會', sci: '自然' };
            const years = ['111', '112', '113', '114'];

            let totalScore = 0;
            subjects.forEach(s => totalScore += scores[s]);

            // 2. 計算各年度點數與統計
            let subjectStats = {}; 
            // format: { chi: { min: 7, max: 1, avg: 0, label: '' }, ... }

            subjects.forEach(sub => {
                let yearlyPoints = [];
                years.forEach(y => {
                    yearlyPoints.push(getPoints(scores[sub], sub, y));
                });
                
                let avgPt = getPoints(scores[sub], sub, 'average');
                
                subjectStats[sub] = {
                    score: scores[sub],
                    min: Math.min(...yearlyPoints),
                    max: Math.max(...yearlyPoints),
                    avg: avgPt,
                    label: pointLabels[avgPt]
                };
            });

            // 計算歷年總點數範圍
            let yearlyTotalPoints = [];
            years.forEach(y => {
                let sum = 0;
                subjects.forEach(sub => sum += getPoints(scores[sub], sub, y));
                yearlyTotalPoints.push(sum);
            });
            let minTotal = Math.min(...yearlyTotalPoints);
            let maxTotal = Math.max(...yearlyTotalPoints);

            // 計算 "平均標準" 的總點數
            let avgTotalPoints = 0;
            subjects.forEach(sub => avgTotalPoints += subjectStats[sub].avg);

            // 計算 114年 的總點數 (用於落點)
            let current114Points = 0;
            subjects.forEach(sub => current114Points += getPoints(scores[sub], sub, '114'));

            // 3. 更新 UI
            updateTable(subjectStats, subjectNames, totalScore, minTotal, maxTotal, avgTotalPoints);
            updateRadarChart(subjectStats, subjects, subjectNames);
            updatePredictions(current114Points);
        }

        function updateTable(stats, names, totalScore, minTotal, maxTotal, avgTotal) {
            const tbody = document.getElementById('resultTableBody');
            tbody.innerHTML = '';

            for (const [key, data] of Object.entries(stats)) {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition";
                tr.innerHTML = `
                    <td class="px-4 py-3 font-medium text-gray-900">${names[key]}</td>
                    <td class="px-4 py-3">${data.score}</td>
                    <td class="px-4 py-3 text-center text-blue-600 font-medium">${data.min}</td>
                    <td class="px-4 py-3 text-center text-red-600 font-medium">${data.max}</td>
                    <td class="px-4 py-3 text-center font-bold text-gray-800">${data.avg}</td>
                    <td class="px-4 py-3 text-center">
                        <span class="px-2 py-1 bg-gray-200 rounded text-xs font-bold">${data.label}</span>
                    </td>
                `;
                tbody.appendChild(tr);
            }

            document.getElementById('totalScoreDisplay').innerText = totalScore.toFixed(1);
            document.getElementById('minTotalPointsDisplay').innerText = minTotal;
            document.getElementById('maxTotalPointsDisplay').innerText = maxTotal;
            document.getElementById('avgTotalPointsDisplay').innerText = avgTotal;
        }

        function updateRadarChart(stats, subjects, names) {
            const ctx = document.getElementById('radarChart').getContext('2d');
            const dataValues = subjects.map(s => stats[s].avg);
            const labels = subjects.map(s => names[s]);

            if (radarChart) {
                radarChart.destroy();
            }

            radarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '五科平均點數',
                        data: dataValues,
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                    }]
                },
                options: {
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 7,
                            min: 0,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    maintainAspectRatio: false
                }
            });
        }

        function updatePredictions(userPoints) {
            const tbody = document.getElementById('schoolListBody');
            const currentPointsDisplay = document.getElementById('currentPointsDisplay');
            const rangeDisplay = document.getElementById('rangeDisplay');

            currentPointsDisplay.innerText = userPoints;
            const minRange = Math.max(0, userPoints - 2);
            const maxRange = userPoints + 2;
            rangeDisplay.innerText = `${minRange} - ${maxRange}`;

            tbody.innerHTML = '';

            // 篩選學校
            const matchedSchools = schoolsData.filter(school => {
                // 寬鬆判定：學校分數在使用者分數 +- 2 範圍內
                // 或者 使用者分數 >= 學校分數 (亦可視為錄取，但題目要求 +-2 落點)
                // 題目：將總點數取+-2點為範圍...查詢可錄取學校
                // 解讀：尋找 "學校錄取分數" 落在 [User-2, User+2] 區間的學校
                // 通常落點分析是 UserScore >= SchoolScore。
                // 若User=20, 找18-22的學校意味著找 "實力相當" 的學校。
                return school.points >= minRange && school.points <= maxRange;
            });

            // 排序：分數高到低
            matchedSchools.sort((a, b) => b.points - a.points);

            if (matchedSchools.length === 0) {
                tbody.innerHTML = '<tr><td colspan="2" class="p-4 text-center text-gray-500">此分數區間內無相符學校建議，或分數過低/過高。</td></tr>';
                return;
            }

            matchedSchools.forEach(school => {
                const tr = document.createElement('tr');
                // 標示風險：若學校分數 > 使用者分數，標示為「夢幻/挑戰」；若 <= 則為「穩健」
                let statusBadge = '';
                if (school.points > userPoints) {
                    statusBadge = '<span class="text-xs ml-2 text-red-500 border border-red-200 px-1 rounded">挑戰</span>';
                } else {
                    statusBadge = '<span class="text-xs ml-2 text-green-500 border border-green-200 px-1 rounded">穩健</span>';
                }

                tr.innerHTML = `
                    <td class="px-4 py-2 font-medium text-gray-800">${school.name} ${statusBadge}</td>
                    <td class="px-4 py-2 text-right text-gray-600">${school.points}</td>
                `;
                tbody.appendChild(tr);
            });
        }
    </script>
</body>
</html>
