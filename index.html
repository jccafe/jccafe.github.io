<!-- Chosen Palette: Warm Neutrals & Tech Blue (Warm Light) -->
<!-- Application Structure Plan:
    1.  **Hero Section:** Introduces the concept of FGV as a "Vault" for data, setting the stage.
    2.  **Core Mechanics (Interactive Diagram):** A CSS-built visualizer of the "Uninitialized Shift Register" concept. Users can toggle states to see how data persists.
    3.  **The U32 Rollover Simulation (Visualization):** A dedicated section with a Chart.js line chart demonstrating the specific mathematical phenomenon of U32 rollover, proving safety without extra code.
    4.  **The Pause Challenge (Interactive Demo):** A functional JS-simulated timer that users can Start, Pause, and Resume. It visualizes the "Bank Deposit" logic in real-time using a chart, contrasting naive time calculation vs. correct accumulator logic.
    5.  **Architecture Blueprint:** Break down of the 3-Shift-Register pattern required for the advanced pause functionality.
    6.  **Logic Cheat Sheet:** A clear, tabular reference for the state machine logic.
    This structure moves from abstract definition -> core mechanic -> specific technical edge case -> complex implementation -> reference/summary.
-->
<!-- Visualization & Content Choices:
    1.  **FGV Memory Concept:**
        * Goal: Inform/Organize.
        * Method: CSS-styled "Block Diagram" simulation.
        * Interaction: Buttons to "Write" and "Read" data, simulating loop execution.
        * Justification: Visualizing the abstract concept of a shift register without SVG is best done with styled HTML borders/boxes.
    2.  **U32 Rollover Behavior:**
        * Goal: Change/Inform.
        * Method: Chart.js Line Chart.
        * Interaction: None (static data story).
        * Justification: Shows the "sawtooth" of the raw tick count vs. the linear stability of the elapsed time calculation.
    3.  **Pause/Resume Accumulator Logic:**
        * Goal: Relationships/Process.
        * Method: Chart.js Area Chart + Live Counters.
        * Interaction: Start/Pause/Resume buttons that update the chart in real-time.
        * Justification: Demonstrates the "Gap" in time that naive subtraction misses, and how the "Accumulator" fills it.
    4.  **Logic Cheat Sheet:**
        * Goal: Organize.
        * Method: HTML Table with hover effects.
        * Interaction: Simple highlighting.
        * Justification: Tables are the standard for logic truth tables.
-->
<!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LabVIEW Timer FGV 互動指南</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #fdfbf7; /* Warm neutral background */
            color: #1f2937;
        }

        /* Chart Container Styling per requirements */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }

        /* CSS-only LabVIEW Diagram Elements */
        .lv-loop {
            border: 4px solid #9ca3af;
            background-color: #f3f4f6;
            border-radius: 8px;
            position: relative;
        }
        .lv-shift-register {
            width: 16px;
            height: 24px;
            background-color: #fbbf24; /* Amber for uninitialized warning/highlight */
            border: 1px solid #d97706;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
        }
        .lv-sr-left { left: -8px; }
        .lv-sr-right { right: -8px; }
        
        .lv-wire {
            height: 4px;
            background-color: #3b82f6; /* Blue wire for numeric/general */
            position: absolute;
        }

        .lv-node {
            background-color: #fef3c7;
            border: 2px solid #d97706;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            color: #78350f;
        }
    </style>
</head>
<body class="bg-[#fdfbf7] text-gray-800 antialiased">

    <!-- Header -->
    <header class="bg-white border-b border-stone-200 sticky top-0 z-50 shadow-sm">
        <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-amber-500 rounded-lg flex items-center justify-center text-white font-bold text-xl">FGV</div>
                <div>
                    <h1 class="text-xl font-bold text-gray-900">LabVIEW Timer FGV 攻略</h1>
                    <p class="text-xs text-gray-500">從基礎架構到進階「暫停」功能實作</p>
                </div>
            </div>
            <nav class="hidden md:flex space-x-6 text-sm font-medium text-gray-600">
                <a href="#basics" class="hover:text-amber-600 transition">基礎原理</a>
                <a href="#u32" class="hover:text-amber-600 transition">U32 歸零</a>
                <a href="#pause" class="hover:text-amber-600 transition">暫停邏輯</a>
                <a href="#cheatsheet" class="hover:text-amber-600 transition">速查表</a>
            </nav>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 py-8 space-y-16">

        <!-- Intro Section -->
        <section class="text-center space-y-6">
            <h2 class="text-4xl md:text-5xl font-bold text-gray-900 leading-tight">
                打造您的 <span class="text-amber-600">程式保險箱</span>
            </h2>
            <p class="text-lg text-gray-600 max-w-3xl mx-auto">
                Functional Global Variable (FGV) 是 LabVIEW 中管理狀態的黃金標準。
                透過「未初始化的位移暫存器」，我們能在不使用全域變數的情況下，安全地儲存與存取時間數據。
            </p>
        </section>

        <!-- SECTION 1: The Core Mechanism -->
        <section id="basics" class="bg-white rounded-2xl shadow-sm border border-stone-200 p-6 md:p-8">
            <div class="grid md:grid-cols-2 gap-12 items-center">
                <div class="space-y-4">
                    <div class="flex items-center space-x-2 text-amber-600 font-bold uppercase tracking-wider text-sm">
                        <span class="w-8 h-[2px] bg-amber-600"></span>
                        <span>核心原理</span>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900">未初始化的記憶</h3>
                    <p class="text-gray-600">
                        一般迴圈的 Shift Register 在開始時會被初始化。但在 FGV 中，我們故意**不連接左側的初始值**。
                        這就像把一個保險箱放在迴圈裡：當 VI 執行結束，保險箱裡的數據不會消失，下次執行時依然存在。
                    </p>
                    <ul class="space-y-2 text-gray-700">
                        <li class="flex items-start">
                            <span class="mr-2 text-amber-500">✓</span>
                            <span><strong>While Loop：</strong>只執行一次 (Stop 接 True)。</span>
                        </li>
                        <li class="flex items-start">
                            <span class="mr-2 text-amber-500">✓</span>
                            <span><strong>Shift Register：</strong>左側留空 = 永久記憶體。</span>
                        </li>
                        <li class="flex items-start">
                            <span class="mr-2 text-amber-500">✓</span>
                            <span><strong>Case Structure：</strong>根據 Enum 指令決定是「寫入」還是「讀取」。</span>
                        </li>
                    </ul>
                </div>

                <!-- Interactive CSS Diagram -->
                <div class="bg-stone-50 p-6 rounded-xl border border-stone-200 flex flex-col items-center">
                    <h4 class="text-sm font-bold text-gray-500 mb-4">FGV 運作模擬圖 (CSS Visualizer)</h4>
                    
                    <div class="relative w-64 h-48 lv-loop shadow-inner flex items-center justify-center mb-6">
                        <span class="absolute top-2 left-2 text-xs text-gray-400 font-mono">While Loop</span>
                        
                        <!-- Shift Registers -->
                        <div class="lv-shift-register lv-sr-left shadow-sm"></div>
                        <div class="lv-shift-register lv-sr-right shadow-sm"></div>

                        <!-- Content -->
                        <div class="w-40 h-28 border border-dashed border-gray-400 rounded flex flex-col items-center justify-center bg-white z-10 p-2">
                            <div class="text-xs text-gray-500 mb-1 font-mono">Case Structure</div>
                            <div id="fgv-value-display" class="text-2xl font-bold text-blue-600">0</div>
                            <div class="text-[10px] text-gray-400 mt-1">Stored Value</div>
                        </div>

                        <!-- Stop Condition -->
                        <div class="absolute bottom-2 right-2 w-4 h-4 rounded-full border border-red-400 bg-red-100 flex items-center justify-center text-[10px] text-red-600">T</div>
                    </div>

                    <div class="flex space-x-4">
                        <button onclick="updateFGV('reset')" class="px-4 py-2 bg-amber-100 text-amber-800 rounded hover:bg-amber-200 font-medium text-sm transition">Reset (寫入時間)</button>
                        <button onclick="updateFGV('read')" class="px-4 py-2 bg-blue-100 text-blue-800 rounded hover:bg-blue-200 font-medium text-sm transition">Read (讀取記憶)</button>
                    </div>
                    <p id="fgv-status-text" class="text-xs text-center mt-3 text-gray-500 h-4">點擊按鈕模擬運作</p>
                </div>
            </div>
        </section>

        <!-- SECTION 2: U32 Rollover -->
        <section id="u32" class="space-y-6">
            <div class="max-w-3xl">
                <div class="flex items-center space-x-2 text-blue-600 font-bold uppercase tracking-wider text-sm">
                    <span class="w-8 h-[2px] bg-blue-600"></span>
                    <span>關鍵技術</span>
                </div>
                <h3 class="text-2xl font-bold text-gray-900 mt-2">U32 歸零問題 (Rollover) 的數學魔法</h3>
                <p class="text-gray-600 mt-4">
                    LabVIEW 的 `Tick Count (ms)` 是一個 U32 (無號 32 位元整數)，大約 49.7 天會達到最大值 (4,294,967,295) 並歸零。
                    直覺上這會造成計算錯誤，但由於二進位運算的特性，**直接相減**依然能得到正確的時間差，無需額外程式碼。
                </p>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-sm border border-stone-200">
                <div class="chart-container">
                    <canvas id="u32Chart"></canvas>
                </div>
                <div class="mt-4 text-center text-sm text-gray-500">
                    <p>圖表顯示：即使系統時間 (粉紅線) 歸零，計算出的經過時間 (藍線) 依然保持線性增加。</p>
                </div>
            </div>
        </section>

        <!-- SECTION 3: The Pause Challenge -->
        <section id="pause" class="grid md:grid-cols-12 gap-8">
            <div class="md:col-span-5 space-y-6">
                <div class="flex items-center space-x-2 text-emerald-600 font-bold uppercase tracking-wider text-sm">
                    <span class="w-8 h-[2px] bg-emerald-600"></span>
                    <span>進階挑戰</span>
                </div>
                <h3 class="text-2xl font-bold text-gray-900">如何實作「暫停」功能？</h3>
                <p class="text-gray-600">
                    系統時間永遠在走，無法暫停。如果只用「現在 - 開始」，休息時間也會被算進去。
                    解決方案是<strong>「銀行存錢法」</strong>：
                </p>
                
                <div class="bg-emerald-50 border-l-4 border-emerald-500 p-4 rounded-r-lg space-y-2">
                    <h4 class="font-bold text-emerald-800">核心公式</h4>
                    <p class="text-lg font-mono text-emerald-700">Total = A + (N - S)</p>
                    <ul class="text-sm text-emerald-700 space-y-1">
                        <li><strong>A (Accumulator):</strong> 銀行存款 (過去累積的時間)</li>
                        <li><strong>N (Now):</strong> 現在系統時間</li>
                        <li><strong>S (Start Time):</strong> 這次起跑的時間</li>
                    </ul>
                </div>

                <div class="space-y-4 pt-4">
                    <h4 class="font-bold text-gray-800">互動體驗區</h4>
                    <p class="text-sm text-gray-600">操作下方的計時器，觀察「累積時間 (A)」如何運作。</p>
                    <div class="flex space-x-2">
                        <button id="btn-reset" class="flex-1 py-2 bg-gray-200 hover:bg-gray-300 rounded text-gray-700 font-bold transition">Reset</button>
                        <button id="btn-start" class="flex-1 py-2 bg-green-500 hover:bg-green-600 rounded text-white font-bold transition">Start</button>
                        <button id="btn-pause" class="flex-1 py-2 bg-amber-500 hover:bg-amber-600 rounded text-white font-bold transition">Pause</button>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div class="bg-white p-3 rounded border border-gray-200">
                            <div class="text-xs text-gray-500">狀態</div>
                            <div id="timer-state" class="font-bold text-gray-800">Stopped</div>
                        </div>
                        <div class="bg-white p-3 rounded border border-gray-200">
                            <div class="text-xs text-gray-500">總時間 (秒)</div>
                            <div id="timer-display" class="font-bold text-2xl text-blue-600">0.0</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="md:col-span-7 bg-white p-6 rounded-2xl shadow-sm border border-stone-200">
                <div class="chart-container">
                    <canvas id="pauseChart"></canvas>
                </div>
                <div class="mt-4 bg-yellow-50 p-3 rounded text-xs text-yellow-800 border border-yellow-100">
                    <strong>觀察重點：</strong> 當你按下 Pause 時，藍色區域 (總時間) 會停止增長，變成平的。
                    這代表「銀行存款」保持不變，且 (Now - Start) 這部分暫時不被計算，直到再次 Start。
                </div>
            </div>
        </section>

        <!-- SECTION 4: Architecture Blueprint -->
        <section class="space-y-6">
            <h3 class="text-2xl font-bold text-gray-900 text-center">進階架構：三個 Shift Register 的分工</h3>
            <p class="text-center text-gray-600 max-w-2xl mx-auto mb-8">
                為了實現上述邏輯，我們的 FGV 需要擴充記憶體容量，從一個增加到三個。
            </p>

            <div class="grid md:grid-cols-3 gap-6">
                <!-- Card 1 -->
                <div class="bg-white p-6 rounded-xl border-t-4 border-blue-500 shadow-sm hover:shadow-md transition">
                    <div class="text-blue-500 font-bold text-lg mb-2">SR 1</div>
                    <h4 class="text-xl font-bold text-gray-900 mb-2">Start Time</h4>
                    <span class="inline-block px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded mb-4">U32 數值</span>
                    <p class="text-gray-600 text-sm">
                        紀錄「這一次」按下 Start 的瞬間系統時間。用於計算當前的動態增量 (Now - Start)。
                    </p>
                </div>
                
                <!-- Card 2 -->
                <div class="bg-white p-6 rounded-xl border-t-4 border-amber-500 shadow-sm hover:shadow-md transition">
                    <div class="text-amber-500 font-bold text-lg mb-2">SR 2</div>
                    <h4 class="text-xl font-bold text-gray-900 mb-2">Accumulator</h4>
                    <span class="inline-block px-2 py-1 bg-amber-100 text-amber-700 text-xs rounded mb-4">U32 數值</span>
                    <p class="text-gray-600 text-sm">
                        我們的「銀行帳戶」。每次暫停時，會將這段時間結算並存入此處。
                    </p>
                </div>

                <!-- Card 3 -->
                <div class="bg-white p-6 rounded-xl border-t-4 border-emerald-500 shadow-sm hover:shadow-md transition">
                    <div class="text-emerald-500 font-bold text-lg mb-2">SR 3</div>
                    <h4 class="text-xl font-bold text-gray-900 mb-2">Is Running?</h4>
                    <span class="inline-block px-2 py-1 bg-emerald-100 text-emerald-700 text-xs rounded mb-4">Boolean 布林</span>
                    <p class="text-gray-600 text-sm">
                        狀態旗標。讀取時用來決定公式：是要加上 (Now - Start)，還是只回傳 Accumulator。
                    </p>
                </div>
            </div>
        </section>

        <!-- SECTION 5: Cheat Sheet -->
        <section id="cheatsheet" class="bg-stone-800 text-stone-100 rounded-2xl shadow-lg p-6 md:p-10 overflow-hidden">
            <h3 class="text-2xl font-bold text-white mb-6 flex items-center">
                <span class="bg-amber-500 w-2 h-8 mr-3 rounded-full"></span>
                實作邏輯速查表 (Cheat Sheet)
            </h3>
            
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="border-b border-stone-600 text-stone-400 text-sm uppercase tracking-wider">
                            <th class="py-4 px-4">狀態 (Enum)</th>
                            <th class="py-4 px-4">SR1 (Start)</th>
                            <th class="py-4 px-4">SR2 (Accum)</th>
                            <th class="py-4 px-4">SR3 (Running)</th>
                            <th class="py-4 px-4">動作描述</th>
                        </tr>
                    </thead>
                    <tbody class="text-sm font-mono">
                        <tr class="border-b border-stone-700 hover:bg-stone-700 transition">
                            <td class="py-4 px-4 font-bold text-amber-400">Reset</td>
                            <td class="py-4 px-4">Now</td>
                            <td class="py-4 px-4">0</td>
                            <td class="py-4 px-4 text-red-400">False</td>
                            <td class="py-4 px-4 text-stone-300 font-sans">歸零：清空存款，停止計時。</td>
                        </tr>
                        <tr class="border-b border-stone-700 hover:bg-stone-700 transition">
                            <td class="py-4 px-4 font-bold text-green-400">Start / Resume</td>
                            <td class="py-4 px-4">Now</td>
                            <td class="py-4 px-4 text-stone-500">不變</td>
                            <td class="py-4 px-4 text-green-400">True</td>
                            <td class="py-4 px-4 text-stone-300 font-sans">開跑：更新起跑點，存款不動。</td>
                        </tr>
                        <tr class="border-b border-stone-700 hover:bg-stone-700 transition">
                            <td class="py-4 px-4 font-bold text-yellow-400">Pause</td>
                            <td class="py-4 px-4 text-stone-500">不變</td>
                            <td class="py-4 px-4 text-yellow-200">A + (N-S)</td>
                            <td class="py-4 px-4 text-red-400">False</td>
                            <td class="py-4 px-4 text-stone-300 font-sans">結帳：將經過時間存入銀行。</td>
                        </tr>
                        <tr class="hover:bg-stone-700 transition">
                            <td class="py-4 px-4 font-bold text-blue-400">Read</td>
                            <td class="py-4 px-4 text-stone-500">不變</td>
                            <td class="py-4 px-4 text-stone-500">不變</td>
                            <td class="py-4 px-4 text-stone-500">不變</td>
                            <td class="py-4 px-4 text-stone-300 font-sans">
                                若 Running: A + (N-S)<br>
                                若 Stopped: A
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

    </main>

    <footer class="bg-stone-100 border-t border-stone-200 mt-16 py-8 text-center text-sm text-gray-500">
        <p>© LabVIEW Learning Module. 基於 Functional Global Variable 設計模式。</p>
    </footer>

    <!-- JavaScript Logic -->
    <script>
        // --- 1. Basic Concept Visualizer Logic ---
        let fgvMemory = 0;
        function updateFGV(action) {
            const display = document.getElementById('fgv-value-display');
            const status = document.getElementById('fgv-status-text');
            const loopBox = document.querySelector('.lv-loop');
            
            if (action === 'reset') {
                // Simulate "Reset" or "Start" - Writing Now
                fgvMemory = Math.floor(Math.random() * 1000); // Simulate Tick Count
                display.innerText = fgvMemory;
                display.classList.remove('text-gray-800');
                display.classList.add('text-amber-600');
                status.innerText = `[Reset] 已寫入新時間: ${fgvMemory}`;
                loopBox.style.borderColor = '#d97706'; // Amber border
                setTimeout(() => loopBox.style.borderColor = '#9ca3af', 500);
            } else if (action === 'read') {
                // Simulate "Read" - Reading Memory
                display.innerText = fgvMemory; // Reads the stored value
                display.classList.remove('text-amber-600');
                display.classList.add('text-blue-600');
                status.innerText = `[Read] 從 Shift Register 讀取: ${fgvMemory}`;
                loopBox.style.borderColor = '#2563eb'; // Blue border
                setTimeout(() => loopBox.style.borderColor = '#9ca3af', 500);
            }
        }

        // --- 2. U32 Rollover Chart ---
        const ctxU32 = document.getElementById('u32Chart').getContext('2d');
        const maxU32 = 4294967295;
        // Data points simulating near max value, rollover, and continuation
        const u32Data = [maxU32 - 30, maxU32 - 20, maxU32 - 10, 0, 10, 20, 30]; 
        const elapsedData = [0, 10, 20, 30, 40, 50, 60]; // Perfectly linear despite rollover
        const labelsU32 = ['T-30', 'T-20', 'T-10', 'ROLLOVER', 'T+10', 'T+20', 'T+30'];

        new Chart(ctxU32, {
            type: 'line',
            data: {
                labels: labelsU32,
                datasets: [
                    {
                        label: 'Elapsed Time (經過時間)',
                        data: elapsedData,
                        borderColor: '#2563eb', // Blue 600
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        borderWidth: 3,
                        yAxisID: 'y1',
                        tension: 0
                    },
                    {
                        label: 'System Tick Count (系統時間)',
                        data: u32Data,
                        borderColor: '#db2777', // Pink 600
                        borderDash: [5, 5],
                        borderWidth: 2,
                        yAxisID: 'y',
                        stepped: true, // Shows the sharp drop
                        tension: 0
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    tooltip: {
                        callbacks: {
                            title: function(tooltipItems) {
                                let label = tooltipItems[0].label;
                                return Array.isArray(label) ? label.join(' ') : label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: { display: true, text: 'Raw Tick Count (U32)' },
                        ticks: { callback: function(value) { return (value/1000000000).toFixed(1) + 'B'; } }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: { display: true, text: 'Calculated Duration' },
                        grid: { drawOnChartArea: false }
                    }
                }
            }
        });

        // --- 3. Pause Logic Interactive Demo ---
        // Variables for the "Engine"
        let timerState = 'Stopped'; // Stopped, Running, Paused
        let accumulator = 0;
        let startTime = 0;
        let timerInterval = null;
        let chartInterval = null;
        
        // Chart Data
        const ctxPause = document.getElementById('pauseChart').getContext('2d');
        const initialDataLength = 20;
        const pauseChartData = {
            labels: Array(initialDataLength).fill(''),
            datasets: [{
                label: 'Total Time (Accumulator + Current)',
                data: Array(initialDataLength).fill(0),
                borderColor: '#059669', // Emerald 600
                backgroundColor: 'rgba(5, 150, 105, 0.2)',
                fill: true,
                tension: 0.1
            }]
        };

        const pauseChart = new Chart(ctxPause, {
            type: 'line',
            data: pauseChartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: { duration: 0 }, // Disable animation for real-time feel
                scales: {
                    x: { display: false },
                    y: { min: 0, title: { display: true, text: 'Total Seconds' } }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            title: function(tooltipItems) {
                                let label = tooltipItems[0].label;
                                return Array.isArray(label) ? label.join(' ') : label;
                            }
                        }
                    }
                }
            }
        });

        // Elements
        const displayEl = document.getElementById('timer-display');
        const stateEl = document.getElementById('timer-state');

        // Functions
        function getNow() { return Date.now(); }

        function updateDisplay() {
            let total = 0;
            if (timerState === 'Running') {
                total = accumulator + (getNow() - startTime);
            } else {
                total = accumulator;
            }
            displayEl.innerText = (total / 1000).toFixed(1);
            
            // Push to Chart
            const sec = total / 1000;
            pauseChart.data.datasets[0].data.push(sec);
            pauseChart.data.datasets[0].data.shift();
            pauseChart.update();
        }

        // Button Handlers
        document.getElementById('btn-reset').addEventListener('click', () => {
            timerState = 'Stopped';
            accumulator = 0;
            startTime = 0; // Not strictly needed for logic but good for reset
            stateEl.innerText = 'Stopped';
            stateEl.className = 'font-bold text-gray-800';
            updateDisplay();
            // Reset chart visuals
            pauseChart.data.datasets[0].data = Array(initialDataLength).fill(0);
            pauseChart.update();
            if(timerInterval) clearInterval(timerInterval);
        });

        document.getElementById('btn-start').addEventListener('click', () => {
            if (timerState === 'Running') return; // Already running
            
            // Logic: Start / Resume
            startTime = getNow(); // Update Start Time (SR1)
            // Accumulator (SR2) stays unchanged
            timerState = 'Running'; // SR3 = True
            
            stateEl.innerText = 'Running';
            stateEl.className = 'font-bold text-green-600';
            
            if(timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(updateDisplay, 100); // 10Hz update
        });

        document.getElementById('btn-pause').addEventListener('click', () => {
            if (timerState !== 'Running') return; // Can only pause if running
            
            // Logic: Pause
            // Accumulator = Accumulator + (Now - Start)
            accumulator = accumulator + (getNow() - startTime);
            timerState = 'Paused'; // SR3 = False
            
            stateEl.innerText = 'Paused';
            stateEl.className = 'font-bold text-amber-600';
            
            if(timerInterval) clearInterval(timerInterval);
            updateDisplay(); // One last update to show finalized paused time
        });

        // 16-char Label Wrapping Helper (Required by prompt, applied to chart titles if needed)
        function wrapLabel(label) {
            if (label.length <= 16) return label;
            const words = label.split(' ');
            const lines = [];
            let currentLine = words[0];
            for (let i = 1; i < words.length; i++) {
                if (currentLine.length + 1 + words[i].length <= 16) {
                    currentLine += ' ' + words[i];
                } else {
                    lines.push(currentLine);
                    currentLine = words[i];
                }
            }
            lines.push(currentLine);
            return lines;
        }

    </script>
</body>
</html>
